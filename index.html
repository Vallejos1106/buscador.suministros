<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Buscador de Suministros</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { font-family: sans-serif; display: flex; margin: 0; }
  #left-panel { width: 30%; padding: 10px; background: #f4f4f4; height: 100vh; overflow-y: auto; }
  #map { flex: 1; height: 100vh; }
  .msg { margin: 5px 0; color: green; }
  .error { color: red; }
</style>
</head>
<body>
<div id="left-panel">
  <h2>Buscar suministro</h2>
  <input type="text" id="searchBox" placeholder="Ingrese número de cliente" />
  <button onclick="buscarSuministro()">Buscar</button>
  <div id="resultado" class="msg"></div>
  <button id="verEnGoogle" style="display:none" onclick="abrirEnGoogleMaps()">Ver en Google Maps</button>
  <h3>Progreso de carga:</h3>
  <ul id="progreso"></ul>
  <h3>Suministros cercanos:</h3>
  <ul id="cercanos"></ul>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let datos = [];
let ultimoEncontro = null;
let map, marker;

const urls = [
  {nombre: "NORTE CHICO", url: "https://dl.dropboxusercontent.com/scl/fi/gq78aaeeowpllmk6aq6u8/NORTE-CHICO.csv?rlkey=amoh5m764nbkoobv8tggbbmhb"},
  {nombre: "COLONIAL", url: "https://dl.dropboxusercontent.com/scl/fi/mo1wrl48ky5v74l3ybfpd/COLONIAL.csv?rlkey=jhcfg302k4re8lnp5aya8o02n"},
  {nombre: "PANAMERICANA", url: "https://dl.dropboxusercontent.com/scl/fi/qpt0c6dqyhututunxgby5/PANAMERICANA.csv?rlkey=gtkcg709xhcohqdu70v8fzo16"}
];

let cargados = 0;

// Mostrar progreso
function actualizarProgreso(nombre, estado){
  const ul = document.getElementById("progreso");
  let li = document.getElementById("li-" + nombre);
  if(!li){
    li = document.createElement("li");
    li.id = "li-" + nombre;
    ul.appendChild(li);
  }
  li.textContent = nombre + ": " + estado;
}

// Cargar automáticamente los CSV desde Dropbox
urls.forEach(f => {
  actualizarProgreso(f.nombre, "Cargando...");
  fetch(f.url)
    .then(r => r.text())
    .then(texto => {
      const lineas = texto.split("\n");
      lineas.slice(1).forEach(l => {
        const cols = l.trim().split(";");
        if(cols.length >= 4){
          datos.push({
            cliente: cols[0].trim(),
            ut: cols[1].trim(),
            lat: parseFloat(cols[2].replace(",", ".")),
            lon: parseFloat(cols[3].replace(",", "."))
          });
        }
      });
      cargados++;
      actualizarProgreso(f.nombre, "Cargado con éxito ("+lineas.length+" filas)");
      if(cargados === urls.length){
        const ul = document.getElementById("progreso");
        let li = document.createElement("li");
        li.style.color = "green";
        li.textContent = "✅ Todos los archivos cargados con éxito. Ya puedes buscar.";
        ul.appendChild(li);
      }
    })
    .catch(err => {
      actualizarProgreso(f.nombre, "❌ Error al cargar");
      console.error("Error cargando", f.nombre, err);
    });
});

function buscarSuministro(){
  if(cargados < urls.length){
    document.getElementById('resultado').textContent = "⚠️ Espera a que se carguen todos los archivos antes de buscar.";
    return;
  }

  const num = document.getElementById('searchBox').value.trim();
  const encontrado = datos.find(d => d.cliente === num);
  if (encontrado){
    ultimoEncontro = encontrado;
    document.getElementById('resultado').textContent = 'Suministro encontrado en ' + encontrado.ut;
    document.getElementById('verEnGoogle').style.display = 'inline';
    actualizarMapa(encontrado.lat, encontrado.lon);

    const cercanos = datos
      .filter(d => d !== encontrado)
      .map(d => ({...d, dist: getDistance(encontrado.lat, encontrado.lon, d.lat, d.lon)}))
      .sort((a,b) => a.dist - b.dist)
      .slice(0,5);

    const ul = document.getElementById('cercanos');
    ul.innerHTML = '';
    cercanos.forEach(c => {
      const li = document.createElement('li');
      li.textContent = 'Cliente: ' + c.cliente + ' (' + c.dist.toFixed(2) + ' km)';
      ul.appendChild(li);
      L.circleMarker([c.lat, c.lon], {radius:6, color:"gray"}).addTo(map);
    });
  } else {
    document.getElementById('resultado').textContent = '❌ Suministro no encontrado';
    document.getElementById('verEnGoogle').style.display = 'none';
    document.getElementById('cercanos').innerHTML = '';
  }
}

function actualizarMapa(lat, lon){
  if (!map){
    map = L.map('map').setView([lat, lon], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data © OpenStreetMap contributors'
    }).addTo(map);
    marker = L.marker([lat, lon]).addTo(map);
  } else {
    map.setView([lat, lon], 14);
    marker.setLatLng([lat, lon]);
  }
}

function abrirEnGoogleMaps(){
  if(ultimoEncontro){
    const url = `https://www.google.com/maps/search/?api=1&query=${ultimoEncontro.lat},${ultimoEncontro.lon}`;
    window.open(url, '_blank');
  }
}

function getDistance(lat1, lon1, lat2, lon2){
  const R = 6371;
  const dLat = (lat2-lat1)*Math.PI/180;
  const dLon = (lon2-lon1)*Math.PI/180;
  const a = Math.sin(dLat/2)*Math.sin(dLat/2)+
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
    Math.sin(dLon/2)*Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}
</script>
</body>
</html>